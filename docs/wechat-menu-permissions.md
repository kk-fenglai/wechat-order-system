# 微信公众号自定义菜单权限说明

## ❌ 当前问题

创建菜单时遇到错误：`errcode: 48001, errmsg: 'api unauthorized'`

这个错误表示你的微信公众号没有自定义菜单的权限。

## 🔍 问题原因

### 1. 微信公众号类型限制

**支持自定义菜单的公众号类型：**
- ✅ **服务号**（推荐）
- ✅ **认证的服务号**
- ❌ **订阅号**（不支持）
- ❌ **未认证的服务号**（部分功能受限）

### 2. 权限要求

**自定义菜单需要以下权限：**
- 自定义菜单权限
- 网页授权权限（用于view类型菜单）
- 客服消息权限（用于click类型菜单）

## 🔧 解决方案

### 方案1：升级为服务号（推荐）

1. **登录微信公众平台**
   - 访问：https://mp.weixin.qq.com
   - 进入：设置 → 账号详情

2. **查看当前账号类型**
   - 如果是订阅号，需要升级为服务号
   - 服务号有更多功能权限

3. **升级步骤**
   - 进入：设置 → 账号迁移
   - 选择"订阅号迁移到服务号"
   - 按照指引完成迁移

### 方案2：使用替代方案

如果无法升级为服务号，可以使用以下替代方案：

#### 2.1 关键词回复
```
用户发送关键词 → 自动回复相应功能
```

**配置示例：**
- 关键词：`订单` → 回复订单管理链接
- 关键词：`支付` → 回复支付功能说明
- 关键词：`帮助` → 回复使用说明

#### 2.2 图文消息
```
发送图文消息 → 包含功能按钮的H5页面
```

#### 2.3 小程序（如果有）
```
关联小程序 → 在小程序中实现完整功能
```

## 📋 检查步骤

### 1. 确认公众号类型

```bash
# 运行检查脚本
node check-wechat-type.js
```

### 2. 查看权限列表

登录微信公众平台：
1. 进入：开发 → 接口权限
2. 查看"自定义菜单"权限状态
3. 查看"网页授权"权限状态

### 3. 申请权限（如果需要）

如果是未认证的服务号：
1. 进入：设置 → 微信认证
2. 完成微信认证
3. 获得更多API权限

## 🚀 临时解决方案

在等待权限或升级期间，可以使用以下临时方案：

### 1. 关键词自动回复

配置关键词回复规则：
- `订单` → 回复订单管理说明
- `支付` → 回复支付流程说明
- `帮助` → 回复使用指南

### 2. 客服消息

当用户发送特定消息时，自动回复功能链接：
- 用户发送：`我要下单`
- 自动回复：订单创建链接和说明

### 3. 图文消息

发送包含功能按钮的图文消息：
- 标题：订单管理系统
- 描述：点击查看订单管理功能
- 链接：指向你的应用页面

## 📱 用户使用方式

### 当前方式（无自定义菜单）
```
用户打开公众号 → 发送关键词 → 获得功能回复
```

### 升级后方式（有自定义菜单）
```
用户打开公众号 → 点击菜单按钮 → 直接使用功能
```

## ⏰ 时间安排

### 立即可以做的
1. 配置关键词自动回复
2. 设置客服消息
3. 准备图文消息模板

### 需要等待的
1. 公众号类型升级
2. 权限申请审核
3. 微信认证完成

## 🔧 技术实现

### 关键词回复配置

在微信公众平台配置：
1. 进入：自动回复 → 关键词回复
2. 添加关键词规则
3. 设置回复内容

### 服务器端处理

在 `src/controllers/WechatController.js` 中添加关键词处理：

```javascript
// 处理关键词消息
function handleKeywordMessage(message) {
  const content = message.Content.toLowerCase();
  
  switch(content) {
    case '订单':
      return {
        type: 'text',
        content: '📦 订单管理功能\n\n请访问：https://your-app.com/orders'
      };
    case '支付':
      return {
        type: 'text', 
        content: '💰 支付功能\n\n请访问：https://your-app.com/payment'
      };
    default:
      return {
        type: 'text',
        content: '请输入：订单、支付、帮助 等关键词'
      };
  }
}
```

---

**建议：** 优先考虑升级为服务号，这样可以获得完整的自定义菜单功能。在等待期间，可以使用关键词回复作为临时解决方案。 